<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta Telchac Puerto - Flask</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 700px; margin-top: 20px; }
        .card { margin-bottom: 25px; border-left: 5px solid #0d6efd; }
        .card-title { color: #0d6efd; font-weight: bold; }
        .form-section h2 { border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid container">
            <span class="navbar-brand mb-0 h1">Encuesta de Propiedades - Telchac</span>
        </div>
    </nav>

    <div class="container">
        {% if error %}
        <div class="alert alert-danger" role="alert">{{ error }}</div>
        {% endif %}

        <form action="/" method="POST" enctype="multipart/form-data">
            <h1 class="text-primary mb-4 mt-3">Formulario de Encuesta</h1>
            
            <div class="card shadow-sm p-4">
                <h4 class="card-title">Datos Generales y Geolocalizaci√≥n</h4>
                
                <p class="mb-3">Folio de Encuesta: <strong class="text-info">{{ folio }}</strong></p>

                <div class="mb-3">
                    <label for="nombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Nombre del residente o 'No presente'" required>
                </div>
                <div class="mb-3">
                    <label for="direccion" class="form-label">Direcci√≥n</label>
                    <input type="text" class="form-control" id="direccion" name="direccion" required>
                </div>
                <div class="mb-3">
                    <label for="colonia" class="form-label">Colonia</label>
                    <input type="text" class="form-control" id="colonia" name="colonia" required>
                </div>
                <div class="mb-3">
                    <label for="telefono" class="form-label">Tel√©fono</label>
                    <input type="tel" class="form-control" id="telefono" name="telefono">
                </div>
                
                <hr>

                <div class="mb-4">
                    <label for="foto_predio" class="form-label">üì∏ Tomar Foto del Predio</label>
                    <input 
                        type="file" 
                        class="form-control" 
                        id="foto_predio" 
                        name="foto_predio" 
                        accept="image/*" 
                        capture="camera"
                    >
                    <small class="form-text text-muted">Aseg√∫rate de que la foto se tome o se seleccione antes de guardar.</small>
                </div>
                
                <input type="hidden" id="latitud_gps" name="latitud_gps" value="" required>
                <input type="hidden" id="longitud_gps" name="longitud_gps" value="" required>

                <button type="button" id="btn_gps" class="btn btn-info mb-3">üìç Obtener Ubicaci√≥n GPS Precisa</button>
                <p id="gps_status" class="text-muted">Estado: Pendiente de obtener ubicaci√≥n.</p>
                <p><small>Latitud: <span id="display_lat">N/A</span> | Longitud: <span id="display_lon">N/A</span></small></p>

            </div>

            <div class="card shadow-sm p-4">
                <h4 class="card-title">Servicio de Recolecci√≥n de Basura</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cmb_basura" class="form-label">Problema basura</label>
                        <select class="form-select" id="cmb_basura" name="cmb_basura">
                            <option value="Bien">Bien</option>
                            <option value="Mal">Mal</option>
                            <option value="Muy mal">Muy mal</option>
                            <option value="No pasa el cami√≥n">No pasa el cami√≥n</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cmb_frec" class="form-label">Frecuencia recolecci√≥n</label>
                        <select class="form-select" id="cmb_frec" name="cmb_frec">
                            <option value="Diario">Diario</option>
                            <option value="Cada 2 d√≠as">Cada 2 d√≠as</option>
                            <option value="Semanal">Semanal</option>
                            <option value="Nunca">Nunca</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cmb_cont_basura" class="form-label">Contrato basura</label>
                        <select class="form-select" id="cmb_cont_basura" name="cmb_cont_basura">
                            <option value="S√≠">S√≠</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="tx_num_cont_basura" class="form-label">N√∫mero contrato basura</label>
                        <input type="number" class="form-control" id="tx_num_cont_basura" name="tx_num_cont_basura">
                    </div>
                </div>
            </div>

            <div class="card shadow-sm p-4">
                <h4 class="card-title">Servicio de Suministro de Agua</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cmb_agua" class="form-label">Problema agua</label>
                        <select class="form-select" id="cmb_agua" name="cmb_agua">
                            <option value="Bien">Bien</option>
                            <option value="Mal">Mal</option>
                            <option value="A veces">A veces</option>
                            <option value="No tiene servicio">No tiene servicio</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cmb_servicio_agua" class="form-label">Servicio agua</label>
                        <select class="form-select" id="cmb_servicio_agua" name="cmb_servicio_agua">
                            <option value="Red municipal">Red municipal</option>
                            <option value="Pipas">Pipas</option>
                            <option value="Pozo">Pozo</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cmb_cont_agua" class="form-label">Contrato agua</label>
                        <select class="form-select" id="cmb_cont_agua" name="cmb_cont_agua">
                            <option value="S√≠">S√≠</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="tx_num_cont_agua" class="form-label">N√∫mero contrato agua</label>
                        <input type="number" class="form-control" id="tx_num_cont_agua" name="tx_num_cont_agua">
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm p-4">
                <h4 class="card-title">Predio y Caracter√≠sticas de la Construcci√≥n</h4>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cmb_tiene_const" class="form-label">¬øTiene construcci√≥n?</label>
                        <select class="form-select" id="cmb_tiene_const" name="cmb_tiene_const">
                            <option value="S√≠">S√≠</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cmb_tipo_const" class="form-label">Tipo de construcci√≥n</label>
                        <select class="form-select" id="cmb_tipo_const" name="cmb_tipo_const">
                            <option value="Casa">Casa</option>
                            <option value="Cuarto">Cuarto</option>
                            <option value="Ampliaci√≥n">Ampliaci√≥n</option>
                            <option value="Negocio">Negocio</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cmb_niveles" class="form-label">Niveles</label>
                        <select class="form-select" id="cmb_niveles" name="cmb_niveles">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="M√°s de 3">M√°s de 3</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cmb_material" class="form-label">Material</label>
                        <select class="form-select" id="cmb_material" name="cmb_material">
                            <option value="Block">Block</option>
                            <option value="Madera">Madera</option>
                            <option value="L√°mina">L√°mina</option>
                            <option value="Mixto">Mixto</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cmb_estado" class="form-label">Estado construcci√≥n</label>
                        <select class="form-select" id="cmb_estado" name="cmb_estado">
                            <option value="Bueno">Bueno</option>
                            <option value="Regular">Regular</option>
                            <option value="Malo">Malo</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cmb_uso" class="form-label">Uso del predio</label>
                        <select class="form-select" id="cmb_uso" name="cmb_uso">
                            <option value="Habitacional">Habitacional</option>
                            <option value="Comercial">Comercial</option>
                            <option value="Mixto">Mixto</option>
                            <option value="Servicio">Servicio</option>
                            <option value="Bodega">Bodega</option>
                            <option value="Taller">Taller</option>
                            <option value="Abandonado">Abandonado</option>
                            <option value="Bald√≠o">Bald√≠o</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="tx_obs_const" class="form-label">Observaciones (detalles relevantes)</label>
                    <textarea class="form-control" id="tx_obs_const" name="tx_obs_const" rows="3"></textarea>
                </div>
            </div>

            <button type="submit" id="submit_btn" class="btn btn-success btn-lg w-100 mt-4 mb-5" disabled>
                üíæ Guardar Encuesta (Obtenga GPS primero)
            </button>
        </form>
    </div>

    <script>
        document.getElementById('btn_gps').addEventListener('click', getAccurateLocation);
        const latInput = document.getElementById('latitud_gps');
        const lonInput = document.getElementById('longitud_gps');
        const statusText = document.getElementById('gps_status');
        const submitBtn = document.getElementById('submit_btn');

        function getAccurateLocation() {
            if (!navigator.geolocation) {
                statusText.innerHTML = 'Estado: ‚ùå Tu navegador no soporta Geolocalizaci√≥n.';
                statusText.classList.remove('text-muted');
                statusText.classList.add('text-danger');
                return;
            }

            statusText.innerHTML = 'Estado: ‚åõ Buscando ubicaci√≥n precisa...';
            submitBtn.disabled = true;

            // Opciones para mayor precisi√≥n y tiempo de espera
            const options = {
                enableHighAccuracy: true,
                timeout: 15000, // 15 segundos para buscar
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(success, error, options);
        }

        function success(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            // 1. Asigna los valores a los campos ocultos del formulario (Flask los recibir√°)
            latInput.value = lat;
            lonInput.value = lon;

            // 2. Actualiza la UI para el usuario
            document.getElementById('display_lat').textContent = lat.toFixed(6);
            document.getElementById('display_lon').textContent = lon.toFixed(6);
            statusText.innerHTML = 'Estado: ‚úÖ Ubicaci√≥n GPS obtenida con √©xito.';
            statusText.classList.remove('text-muted', 'text-danger');
            statusText.classList.add('text-success');

            // 3. Habilita el bot√≥n de guardar
            submitBtn.disabled = false;
            submitBtn.textContent = 'üíæ Guardar Encuesta';
        }

        function error(err) {
            let msg = 'Error desconocido';
            switch (err.code) {
                case err.PERMISSION_DENIED:
                    msg = "El usuario deneg√≥ la solicitud de Geolocalizaci√≥n.";
                    break;
                case err.POSITION_UNAVAILABLE:
                    msg = "Informaci√≥n de ubicaci√≥n no disponible.";
                    break;
                case err.TIMEOUT:
                    msg = "La solicitud para obtener la ubicaci√≥n expir√≥.";
                    break;
            }
            statusText.innerHTML = `Estado: ‚ùå Error (${msg})`;
            statusText.classList.remove('text-muted', 'text-success');
            statusText.classList.add('text-danger');
            submitBtn.disabled = true;
            submitBtn.textContent = 'üíæ Guardar Encuesta (Obtenga GPS primero)';
            console.warn(`ERROR(${err.code}): ${err.message}`);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>